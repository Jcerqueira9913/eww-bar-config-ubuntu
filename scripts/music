#!/usr/bin/env python3
import json
import sys

# Tenta importar a biblioteca nativa de comunicação do Linux
try:
    import dbus
except ImportError:
    # Fallback de emergência se faltar a lib (raro no Ubuntu)
    print(json.dumps({"status": "closed", "title": "Erro: python-dbus", "class": "music-off", "icon": "MX", "action_play": "", "action_next": "", "action_prev": ""}))
    sys.exit()

def get_spotify_data():
    try:
        # 1. Liga-se ao Sistema de Mensagens (Session Bus)
        bus = dbus.SessionBus()

        # 2. Tenta encontrar o Spotify especificamente
        proxy = bus.get_object('org.mpris.MediaPlayer2.spotify', '/org/mpris/MediaPlayer2')
        properties_manager = dbus.Interface(proxy, 'org.freedesktop.DBus.Properties')

        # 3. Pede os dados DIRETAMENTE à fonte (sem intermediários)
        # Interface Player
        meta = properties_manager.Get('org.mpris.MediaPlayer2.Player', 'Metadata')
        status = properties_manager.Get('org.mpris.MediaPlayer2.Player', 'PlaybackStatus')

        return status, meta
    except dbus.exceptions.DBusException:
        # Se der erro aqui, é porque o Spotify NÃO está a correr
        return None, None

# Executa a função
status_text, metadata = get_spotify_data()

# --- CENÁRIO 1: SPOTIFY FECHADO ---
if status_text is None:
    print(json.dumps({
        "status": "closed",
        "title": "Desligado",
        "artist": "",
        "icon": "",
        "class": "music-off",
        "action_play": "spotify &",
        "action_next": "",
        "action_prev": ""
    }))
    sys.exit()

# --- CENÁRIO 2: SPOTIFY ABERTO ---

# Extrair Título (xesam:title)
# DBus retorna tipos complexos, convertemos para string
try:
    title = str(metadata.get('xesam:title', 'Música Sem Nome'))
except:
    title = "Desconhecido"

# Extrair Artista (xesam:artist) - Geralmente é uma lista ['Artista'], pegamos o primeiro
try:
    artist_list = metadata.get('xesam:artist', [''])
    artist = str(artist_list[0]) if len(artist_list) > 0 else ""
except:
    artist = ""

# Lógica de Ícones
if status_text == "Playing":
    icon = ""
    css_class = "music-playing"
    # Usamos dbus-send para garantir que o comando funciona sem playerctl
    act_play = "dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlayPause"
else:
    icon = ""
    css_class = "music-paused"
    act_play = "dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlayPause"

# JSON Final
print(json.dumps({
    "status": status_text,
    "title": title,
    "artist": artist,
    "icon": icon,
    "class": css_class,
    "action_play": act_play,
    "action_next": "dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Next",
    "action_prev": "dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Previous"
}))