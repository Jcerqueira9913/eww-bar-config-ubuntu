;; --- VARI√ÅVEIS (Apontam para os scripts) ---
(defpoll time :interval "1s" "date +'%H:%M'")
(defpoll date :interval "1h" "date +'%a, %d %b'")
(defvar show_vol false)
(defvar show_bright false)
(defpoll net :interval "3s" "scripts/network")
(defvar notifications_json "[]")
(defpoll bt_devices :interval "5s" "scripts/bluetooth")
(defpoll bt_status :interval "2s" "scripts/bluetooth status")
(defpoll music_info :interval "1s" "scripts/music")
;; Polling do Gravador (1s para atualizar o contador)
(defpoll record_status :interval "1s" "scripts/record status")
;; Polling Estado Bluetooth (Icon, Text, Class, Power)
(defpoll bt_state :interval "2s" "scripts/bluetooth current")

;; Vari√°veis do Dashboard
(defpoll username :interval "24h" "scripts/user name")

;; Polling da lista de redes (Atualiza a cada 5s quando aberta)
(defpoll wifi_networks :interval "5s" :initial "[]" "scripts/wifi_list")
(defpoll current_wifi :interval "2s" "scripts/wifi_list current")

;; Vari√°vel para controlar a janela
(defvar wifi_rev false)

;; Hardware (Apontam para o script sys_info)
(defpoll cpu :interval "2s" "scripts/sys_info cpu")
(defpoll ram :interval "2s" "scripts/sys_info ram")
(defpoll disk :interval "5m" "scripts/sys_info disk")

;; Scripts Inteligentes
(defpoll volume :interval "0.1s" "scripts/volume vol")
(defpoll vol_icon :interval "0.1s" "scripts/volume icon")
(defpoll brightness :interval "1s" "brightnessctl -m | awk -F, '{print substr($4, 0, length($4)-1)}'")
(defpoll battery :interval "30s" "scripts/battery percent")
(defpoll bat_icon :interval "30s" "scripts/battery icon")
(defpoll wifi_icon :interval "3s" "scripts/network")

;; Sistema
(defpoll music_title :interval "1s" "playerctl metadata --format '{{ title }}' || echo ''")
(defpoll current_ws :interval "0.5s" "xdotool get_desktop")


;; --- WIDGETS ---

;; 1. ESQUERDA: Logo -> Workspaces -> Hardware
(defwidget left []
  (box :orientation "h" :space-evenly false :halign "start" :class "left-container"
    ;; LOGO
    (button :class "arch-logo" :onclick "gnome-control-center" "Û∞ïà")
    
    ;; WORKSPACES
    (box :class "workspaces" :orientation "h" :spacing 5
      (button :class {current_ws == 0 ? "ws-active" : "ws-inactive"} :onclick "xdotool set_desktop 0" "‚óè")
      (button :class {current_ws == 1 ? "ws-active" : "ws-inactive"} :onclick "xdotool set_desktop 1" "‚óè")
      (button :class {current_ws == 2 ? "ws-active" : "ws-inactive"} :onclick "xdotool set_desktop 2" "‚óè")
      (button :class {current_ws == 3 ? "ws-active" : "ws-inactive"} :onclick "xdotool set_desktop 3" "‚óè")
    )

    (label :text "|" :class "sep-small")

    ;; HARDWARE (Agora mostra GBs)
    (box :class "stats-box" :spacing 12
      ;; CPU continua em %
      (label :text "Ôíº ${cpu}%" :class "icon-cpu" :tooltip "CPU Load")
      
      ;; RAM (Ex: 4G/16G)
      (label :text "ÓøÖ ${ram}" :class "icon-ram" :tooltip "RAM Usada/Total")
      
      ;; DISCO (Ex: 50G/200G)
      (label :text "ÔÇ† ${disk}" :class "icon-disk" :tooltip "Disco Usado/Total")
    )

    (label :text "„Ö§ ‚óÜ  " :class "deco-diamond")
    (music_bar_ctrl)
    (label :text "„Ö§‚óÜ" :class "deco-diamond")
  )
)

;; 2. CENTRO: Notifica√ß√£o -> Data -> Hora
(defwidget center []
  (box :orientation "h" :space-evenly false :halign "center" :class "center-container"
    (button :onclick "eww open closer && eww open dashboard" :class "btn-datetime"
      (box :orientation "h" :space-evenly false
        (label :text "ÔÉ≥" :class "icon-notify")
        (label :text "|" :class "sep")
        (label :text "ÔÑ≥ ${date}" :class "date-icon")
        (label :text "|" :class "sep")
        (label :text "ÔÄó ${time}" :class "time-icon")
      )
    )
    (label :text "„Ö§ ‚óÜ " :class "deco-diamond")
    (button :class "browser-btn" 
          :onclick "(wmctrl -xa firefox || firefox &)" 
          :tooltip "Firefox"
          (label :text "Û∞àπ" 
           :class "browser-icon" 
           :halign "center" 
           :valign "center"))
  )
)

;; 3. DIREITA: M√∫sica ... Som -> Brilho -> Rede -> Bateria -> Power
(defwidget right []
  (box :orientation "h" :space-evenly false :halign "end" :class "right-container" :spacing 8
    (recorder)
    (button :onclick "eww open closer && eww open bluetooth_window" 
            :class "icon-bt ${bt_state.class}" 
            "${bt_state.icon}  ${bt_state.text}"
            )
            (label :text "‚óÜ" :class "sep-icon")
    ;; REDE: Mostra √çcone + Nome. Clica para abrir/fechar menu.
    (button :onclick "eww open closer && eww open wifi_window" 
            :class "icon-wifi ${net.class}" 
            ;; Mostra √≠cone e SSID (limitado a 10 letras para n√£o estragar a barra)
            "${net.icon}  ${net.ssid}" 
    )
    
    ;; --- M√ìDULO DE SOM (√çcone + Barra Deslizante) ---
    (box :class "module-vol" :space-evenly false :orientation "h" :spacing 3
      ;; Bot√£o do √çcone (Abre/Fecha)
      (button :onclick "eww update show_vol=${!show_vol}" 
              :class "icon-vol" 
              "${vol_icon}")
      
      ;; Barra que aparece (Revealer)
      (revealer :transition "slideleft" :reveal show_vol :duration "350ms"
        (scale :class "volbar"
               :value volume
               :orientation "h"
               :tooltip "${volume}%"
               :max 101
               :min 0
               :onchange "pamixer --set-volume {}")
      )
      ;; Mostra % s√≥ se a barra estiver fechada
      (label :visible {!show_vol} :text "${volume}%" :class "text-vol")
    )

    ;; --- M√ìDULO DE BRILHO (√çcone + Barra Deslizante) ---
    (box :class "module-bright" :space-evenly false :orientation "h" :spacing 3
      (button :onclick "eww update show_bright=${!show_bright}" 
              :class "icon-bright" 
              "Ôî¢")
      
      (revealer :transition "slideleft" :reveal show_bright :duration "350ms"
        (scale :class "brightbar"
               :value brightness
               :orientation "h"
               :tooltip "${brightness}%"
               :max 101
               :min 0
               :onchange "brightnessctl s {}%")
      )
      (label :visible {!show_bright} :text "${brightness}%" :class "text-bright")
    )

    ;; BATERIA
    (button :onclick "gnome-power-statistics" :class "icon-bat" "${bat_icon} ${battery}%")
    
    ;; POWER
    (button :class "icon-power" :onclick "eww open closer && eww open powermenu" "ÔÄë")
  )
)

(defwidget bar_layout []
  (centerbox :orientation "h" :class "bar-container"
    (left)
    (center)
    (right)
  )
)

;; --- JANELA ---
(defwindow bar
  :monitor 0
  :reserve (struts :distance "40px" :side "top")
  :geometry (geometry :x "0%"
                      :y "0%"
                      :width "100%"
                      :height "40px"
                      :anchor "top center")
  :stacking "fg"
  :windowtype "dock"
  :wm-ignore false
  (bar_layout)
)

; --- JANELA POPUP WIFI ---
(defwindow wifi_window
  :monitor 0
  :geometry (geometry :x "-7%"
                      :y "40px" ;; Vai ser ancorada ao topo direito
                      :width "15%"
                      :height "30%"
                      :anchor "top right")
  :stacking "overlay"
  (wifi_widget)
)

;; --- WIDGET DO WIFI ---
(defwidget wifi_widget []
  (box :orientation "v" :space-evenly false :class "wifi-popup"
    
    ;; CABE√áALHO: Rede Atual
    (box :class "wifi-header" :orientation "h" :space-evenly false :spacing 10
      (label :text "Ôá´" :class "wifi-header-icon")
      (box :orientation "v" 
        (label :text "" :class "wifi-title" :halign "start")
        (label :text "${current_wifi}" :class "wifi-subtitle" :halign "start")
      )
      ;; Bot√£o para abrir defini√ß√µes completas
      (button :class "wifi-settings-btn" :onclick "gnome-control-center wifi &" "ÔÄì")
    )
    
    (label :text "Redes Dispon√≠veis" :class "wifi-sep")

    ;; LISTA DE REDES (Scroll√°vel)
    (scroll :vscroll true :hscroll false :height 300
      (box :orientation "v" :spacing 5 :space-evenly false
        ;; Loop que cria bot√µes baseados no JSON do script
        (for network in wifi_networks
          (button :class "wifi-item" 
                  ;; Clicar tenta conectar (Funciona melhor em redes conhecidas)
                  :onclick "nmcli device wifi connect '${network.ssid}' &"
            (box :orientation "h" :space-evenly false 
              (label :text "${network.icon}" :class "wifi-item-icon")
              (label :text "${network.ssid}" :class "wifi-item-text")
              (label :text "${network.signal}%" :class "wifi-item-signal")
            )
          )
        )
      )
    )
  )
)

;; --- JANELA POWER MENU (Centralizada) ---
(defwindow powermenu
  :monitor 0
  :geometry (geometry :x "0%"
                      :y "40px"
                      :width "40%"    ;; Largura da janela
                      :height "20%"   ;; Altura
                      :anchor "center")
  :stacking "overlay"
  (power_widget)
)

;; --- WIDGET DO POWER MENU ---
(defwidget power_widget []
  (box :orientation "v" :space-evenly true :class "powermenu-container"
    
    (label :text "Escolha uma a√ß√£o" :class "powermenu-title")

    ;; Caixa com os 4 bot√µes
    (box :orientation "h" :space-evenly true :spacing 20
      
      ;; 1. BLOQUEAR (Lock)
      (button :class "btn-lock" 
              :onclick "loginctl lock-session & eww close powermenu" 
        (box :orientation "v"
          (label :text "ÔÄ£" :class "btn-icon")
          (label :text "Bloquear" :class "btn-text")
        )
      )

      ;; 2. SAIR (Logout)
      (button :class "btn-logout" 
              :onclick "gnome-session-quit --logout --no-prompt & eww close powermenu" 
        (box :orientation "v"
          (label :text "ÔÇã" :class "btn-icon")
          (label :text "Sair" :class "btn-text")
        )
      )

      ;; 3. REINICIAR (Reboot)
      (button :class "btn-reboot" 
              :onclick "systemctl reboot & eww close powermenu" 
        (box :orientation "v"
          (label :text "ÔÉ¢" :class "btn-icon")
          (label :text "Reiniciar" :class "btn-text")
        )
      )

      ;; 4. DESLIGAR (Shutdown)
      (button :class "btn-off" 
              :onclick "systemctl poweroff & eww close powermenu" 
        (box :orientation "v"
          (label :text "ÔÄë" :class "btn-icon")
          (label :text "Desligar" :class "btn-text")
        )
      )
    )

    ;; Bot√£o CANCELAR (Fecha o menu)
    (button :class "btn-cancel" :onclick "eww close powermenu" "Cancelar")
  )
)
(defwindow closer
  :monitor 0
  :geometry (geometry :width "100%" :height "100%")
  :stacking "fg"
  :focusable false
  (button :onclick "eww close dashboard powermenu music_window wifi_window bluetooth_window closer" :class "closer-btn" "")
)
;; --- JANELA DASHBOARD (Central) ---
(defwindow dashboard
  :monitor 0
  :geometry (geometry :x "0%"
                      :y "40px"
                      :width "20%"
                      :height "30%"
                      :anchor "top center")
  :stacking "overlay"
  (dashboard_widget)
)

;; --- CONTE√öDO DO DASHBOARD ---
(defwidget dashboard_widget []
  (box :orientation "v" :space-evenly false :class "dashboard-container"
    
    ;; 1. TOPO: Perfil e Sauda√ß√£o
    (box :orientation "h" :space-evenly false :class "dash-profile" :spacing 15
      (label :text "ÔÄá" :class "dash-pfp-icon") ;; Ou usa (image) se tiveres foto
      (box :orientation "v" :valign "center"
        (label :text "Ol√°, ${username}" :class "dash-welcome" :halign "start")
        (label :text "${date}" :class "dash-date" :halign "start")
      )
    
    ;; ESPA√áADOR (Empurra o bot√£o fechar para a direita)
      (box :hexpand true)

    )
    ;; 2. CALEND√ÅRIO GIGANTE
    (box :class "dash-cal-box"
      (calendar :class "dash-calendar" 
                :show-heading true
                :show-day-names true)
    )

    ;; 3. LISTA DE NOTIFICA√á√ïES (NOVO)
    (box :orientation "v" :spacing 5 :space-evenly false :class "notif-list"
      (for notif in notifications_json
        (box :orientation "v" :class "notif-item" :space-evenly false
          (label :text "${notif.title}" :class "notif-title" :halign "start" :limit-width 30)
          (label :text "${notif.body}" :class "notif-body" :halign "start" :limit-width 40 :wrap true)
        )
      )
      ;; Bot√£o para limpar
      (button :onclick "/usr/bin/python3 /home/jc/.config/eww/scripts/notifications.py clear" 
        :class "notif-clear-btn" 
        "Limpar Tudo")
    )
    ;; 3. RODAP√â (Links R√°pidos)
    (box :orientation "h" :class "dash-links" :spacing 10
      (button :class "dash-btn" :onclick "gnome-control-center &" "ÔÄì Defini√ß√µes")
      (button :class "dash-btn" :onclick "nautilus &" "ÔÅº Ficheiros")
    )
  )
)

;; --- JANELA POPUP BLUETOOTH ---
(defwindow bluetooth_window
  :monitor 0
  :geometry (geometry :x "-20%"
                      :y "40px"
                      :width "15%"
                      :height "30%"
                      :anchor "top right")
  :stacking "overlay"
  (bluetooth_widget)
)

;; --- WIDGET DO BLUETOOTH ---
(defwidget bluetooth_widget []
  (box :orientation "v" :space-evenly false :class "wifi-popup"

    ;; CABE√áALHO
    (box :class "wifi-header" :orientation "h" :space-evenly false :spacing 10

      ;; √çcone Grande
      (label :text {bt_state.icon} :class "wifi-header-icon ${bt_state.class}")

      ;; Texto (Nome do Device ou Estado)
      (box :orientation "v" :hexpand true
        (label :text "Bluetooth" :class "wifi-title" :halign "start")
        (label :text {bt_state.text} :class "wifi-subtitle" :halign "start" :limit-width 15)
      )

      ;; NOVO: Interruptor LIGAR/DESLIGAR (Power)
      ;; Se estiver ON mostra bot√£o verde, se OFF mostra vermelho
      (button :class "bt-power-btn ${bt_state.power == 'on' ? 'btn-on' : 'btn-off'}" 
              :onclick "scripts/bluetooth toggle &" 
              "ÔÄë")

      ;; Bot√£o Defini√ß√µes
      (button :class "wifi-btn-tool" :onclick "gnome-control-center bluetooth &" "ÔÄì")

      ;; Bot√£o Fechar
      (button :class "wifi-btn-close" :onclick "eww close bluetooth_window closer" "Û∞Öñ")
    )

    (label :text "Dispositivos Emparelhados" :class "wifi-sep")

    ;; (A lista mant√©m-se igual...)
    (scroll :vscroll true :hscroll false :height 300
      (box :orientation "v" :spacing 5 :space-evenly false
        (for device in bt_devices
          (button :class "wifi-item" 
                  :onclick "bluetoothctl ${device.state == 'connected' ? 'disconnect' : 'connect'} ${device.mac} &"
            (box :orientation "h" :space-evenly false 
              (label :text "${device.icon}" :class "wifi-item-icon ${device.color}")
              (label :text "${device.name}" :class "wifi-item-text" :limit-width 20)
            )
          )
        )
      )
    )
  )
)
;; --- JANELA POPUP M√öSICA ---
(defwindow music_window
  :monitor 0
  :geometry (geometry :x "-15%"
                      :y "40px"
                      :width "350px"
                      :anchor "top center")
  :stacking "overlay"
  (music_widget)
)

;; --- WIDGET PRINCIPAL ---
(defwidget music_widget []
  
  (box :class "music-popup" 
       :orientation "v" 
       :space-evenly false
       :valign "start"
       :vexpand false      ;; Importante: N√£o deixa crescer verticalmente
       
    ;; --- 1. CABE√áALHO (Bot√£o Fechar) ---
    (box :orientation "h" :halign "end"
      (button :class "music-close-btn" :onclick "eww close music_window closer" "Û∞Öñ")
    )

    ;; --- 2. CASO 1: SPOTIFY FECHADO ---
    (box :orientation "v" 
         :class "music-empty-box" 
         :spacing 15
         :visible {music_info.status == "closed"}
         :vexpand false

      (label :text "Û∞ìá" :class "music-empty-icon")
      (label :text "Spotify est√° fechado" :class "music-empty-text")
      (button :class "music-launch-btn" 
              :onclick "spotify & eww close music_window closer" 
              "Iniciar Spotify")
    )

    ;; --- 3. CASO 2: A TOCAR (Player) ---
    (box :orientation "v" 
         :space-evenly false 
         :spacing 10
         :visible {music_info.status != "closed"}
         :vexpand false

      ;; A. Info (Capa pequena + Texto)
      (box :orientation "h" :space-evenly false :class "music-info-box" :spacing 15
        (label :text "ÔÄÅ" :class "music-art-icon")
        
        ;; CORRE√á√ÉO DE SINTAXE AQUI:
        (button :class "music-title-btn" 
                :onclick "(wmctrl -xa Spotify || spotify &) && eww close music_window closer"
          (box :orientation "v" :valign "center" :hexpand true
            (label :text "${music_info.title}" :class "music-title" :limit-width 20 :halign "start")
            (label :text "${music_info.artist}" :class "music-artist" :limit-width 20 :halign "start")
          )
        )
      )

      ;; B. Controlos
      (box :orientation "h" :class "music-controls" :spacing 20 :halign "center"
        (button :class "music-heart-btn ${music_info.is_liked ? 'liked' : ''}" 
                :tooltip {music_info.is_liked ? "Remover dos Favoritos" : "Adicionar aos Favoritos"}
                :onclick "/home/jc/.config/eww/scripts/spotify_add_like '${music_info.artist}' '${music_info.title}'" 
                {music_info.is_liked ? "ÔÄÑ" : "ÔÇä"})
        (button :class "music-ctl-btn" :onclick "${music_info.action_prev}" "ÔÅà")
        (button :class "music-play-btn" :onclick "${music_info.action_play}" "${music_info.icon}")
        (button :class "music-ctl-btn" :onclick "${music_info.action_next}" "ÔÅë")
      )

      ;; C. Capa do √Ålbum (Imagem Grande)
      (box :class "album-art" 
           :style "background-image: url('${music_info.image}');"
           ;; width removido para usar 100% da box
           :height 300
           :vexpand false
      )
    )
  )
)

(defwidget music_bar_ctrl []
  (box :orientation "h" :space-evenly false :class "bar-music-container"
    
    ;; 1. CONTROLOS (S√≥ aparecem se N√ÉO estiver fechado/desligado)
    (box :orientation "h" 
         :space-evenly false 
         :spacing 7
         :visible {music_info.status != "closed"}

      ;; Agora usamos as a√ß√µes vindas do Python para garantir que funcionam
      (button :class "bar-music-btn" :onclick "${music_info.action_prev}" "ÔÅà")
      (button :class "bar-music-btn" :onclick "${music_info.action_play}" "${music_info.icon}")
      (button :class "bar-music-btn" :onclick "${music_info.action_next}" "ÔÅë")
      
      (label :text "|" :class "sep")
    )

    ;; 2. BOT√ÉO DE T√çTULO (Mostra sempre o texto)
    (button :onclick "eww open closer && eww open music_window" 
            :class "bar-music-title ${music_info.class}"
            (label :text "ÔÄÅ  ${music_info.title}" 
               :limit-width 150
               :show-truncated true)
    )
  )
)

(defwidget recorder []
  (button :class "record-btn ${record_status.class}" 
          :onclick "scripts/record toggle"
          :tooltip "Screen Recorder"
    (box :orientation "h" :space-evenly false :spacing 5
      ;; √çcone (Muda entre Camara e Stop)
      (label :text "${record_status.icon}" :class "rec-icon")

      ;; Tempo (S√≥ vis√≠vel se estiver a gravar)
      (label :text "${record_status.time}" 
             :visible {record_status.status == "recording"}
             :class "rec-time")
    )
  )
)

(defwindow panic_overlay
  :monitor 0
  :geometry (geometry :x "0%"
                      :y "0%"
                      :width "100%"
                      :height "100%"
                      :anchor "center")
  :stacking "overlay"
  :wm-ignore true
  (box :class "panic-container"
       :orientation "v"
       :valign "center"
       :halign "center"
       :space-evenly false
    (label :class "panic-icon" :text "üíæ")
    (label :class "panic-text" :text "Stopping Recorder...")
  )
)